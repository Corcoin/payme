<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JDA Marketplace</title>
<script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>
<style>
body, html { margin:0; padding:0; font-family:'Segoe UI',sans-serif; background:#0f0f0f; color:#fff; min-height:100vh; display:flex; justify-content:center; align-items:flex-start; }
.container { width:100%; max-width:1400px; padding:20px; display:grid; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); gap:20px; }
.card { background:#1a1a1a; border-radius:12px; padding:20px; box-shadow:0 6px 15px rgba(0,0,0,0.6); transition:0.2s; }
.card:hover { transform:translateY(-4px); box-shadow:0 12px 25px rgba(0,0,0,0.7); }
input, button { width:100%; padding:12px; margin:5px 0; border-radius:8px; border:none; font-size:1em; }
input { background:#222; color:#fff; }
input:focus { outline:2px solid #0af; background:#1e1e1e; }
button { background:linear-gradient(90deg,#0af,#08f); color:#fff; font-weight:600; cursor:pointer; transition:0.2s; }
button:hover { background:linear-gradient(90deg,#08f,#0af); transform:translateY(-2px); }
h2 { color:#0af; text-align:center; margin-bottom:10px; }
pre { background:#111; padding:10px; border-radius:8px; overflow-x:auto; }
canvas { display:block; margin:10px auto; border-radius:12px; background:#fff; }
@media(max-width:768px){ .container{ grid-template-columns:1fr; } }
</style>
</head>
<body>

<!-- AUTH -->
<div class="container" id="auth">
    <div class="card">
        <h2>Signup</h2>
        <input id="su_email" placeholder="Email">
        <input id="su_paypal" placeholder="PayPal Email">
        <input id="su_pass" type="password" placeholder="Password">
        <button onclick="signup()">Signup</button>
    </div>
    <div class="card">
        <h2>Login</h2>
        <input id="li_email" placeholder="Email">
        <input id="li_pass" type="password" placeholder="Password">
        <button onclick="login()">Login</button>
    </div>
</div>

<!-- DASHBOARD -->
<div class="container" id="dashboard" style="display:none;">
    <div class="card">
        <h2>Wallet</h2>
        <pre id="me"></pre>
    </div>
    <div class="card">
        <h2>Live Price</h2>
        <div id="price">$0.01</div>
    </div>
    <div class="card">
        <h2>Deposit USD</h2>
        <input id="deposit_amount" placeholder="USD Amount">
        <button onclick="createPaypalOrder()">Pay with PayPal</button>
        <canvas id="qr" width="150" height="150"></canvas>
    </div>
    <div class="card">
        <h2>Buy Coins</h2>
        <input id="buy_usd" placeholder="USD Amount">
        <button onclick="buy()">Buy</button>
    </div>
    <div class="card">
        <h2>P2P Trade</h2>
        <input id="tr_buyer" placeholder="Buyer ID">
        <input id="tr_amt" placeholder="Amount">
        <button onclick="trade()">Sell</button>
    </div>
    <div class="card">
        <h2>Buyers Pool</h2>
        <pre id="pool"></pre>
    </div>
</div>

<script>
const BASE_URL = "http://localhost:8000/api.php";
let currentUser = null;

/* ---- AUTH ---- */
function signup(){
    const data = new URLSearchParams({
        email: su_email.value,
        paypal: su_paypal.value,
        password: su_pass.value
    });
    fetch(`${BASE_URL}/api.php?api=signup`,{method:'POST',body:data,credentials:'include'})
    .then(r=>r.json()).then(alert);
}

function login(){
    const data = new URLSearchParams({
        email: li_email.value,
        password: li_pass.value
    });
    fetch(`${BASE_URL}/api.php?api=login`,{method:'POST',body:data,credentials:'include'})
    .then(r=>r.json()).then(t=>{
        if(t.ok){
            auth.style.display='none';
            dashboard.style.display='grid';
            loadMe();
            loadPool();
            generateQR();
            startPriceStream();
        } else alert("Login failed");
    });
}

/* ---- USER INFO ---- */
function loadMe(){
    fetch(`${BASE_URL}/api.php?api=me`,{credentials:'include'})
    .then(r=>r.json())
    .then(u=>{
        currentUser = u;
        me.innerText = `USD: $${u.balance_usd.toFixed(2)}\nJDA: ${u.balance_jda.toFixed(2)}`;
    });
}

/* ---- LIVE PRICE (SSE) ---- */
function startPriceStream(){
    const sse = new EventSource(`${BASE_URL}/api.php?stream=1`);
    sse.onmessage = e=>{
        const p = JSON.parse(e.data).price;
        price.innerText = `$${parseFloat(p).toFixed(5)}`;
    };
}

/* ---- BUY COINS ---- */
function buy(){
    const data = new URLSearchParams({usd: buy_usd.value});
    fetch(`${BASE_URL}/api.php?api=buy`,{method:'POST',body:data,credentials:'include'})
    .then(r=>r.json())
    .then(loadMe);
}

/* ---- TRADE ---- */
function trade(){
    const data = new URLSearchParams({buyer:tr_buyer.value, amt:tr_amt.value});
    fetch(`${BASE_URL}/api.php?api=trade`,{method:'POST',body:data,credentials:'include'})
    .then(r=>r.json()).then(d=>alert("TX: "+d.tx));
}

/* ---- BUYERS POOL ---- */
function loadPool(){
    fetch(`${BASE_URL}/api.php?api=buyers`,{credentials:'include'})
    .then(r=>r.json())
    .then(d=>{
        pool.innerText = d.map(u=>`ID:${u.id} | ${u.email} | JDA:${u.balance_jda.toFixed(2)}`).join("\n");
    });
}

/* ---- QR CODE ---- */
function generateQR(){
    if(!currentUser) return;
    new QRious({element:document.getElementById('qr'),value:"paypal:"+currentUser.paypal,width:150,height:150});
}

/* ---- SERVER-SIDE PAYPAL ---- */
async function createPaypalOrder(){
    const amt = parseFloat(deposit_amount.value);
    if(!amt || !currentUser) return alert("Enter USD amount");

    // create order on server
    const res = await fetch(`${BASE_URL}/api.php?api=paypal_order`,{
        method:'POST',
        body: JSON.stringify({amount: amt}),
        credentials:'include'
    });
    const order = await res.json();
    const orderID = order.id;

    // capture order
    const cap = await fetch(`${BASE_URL}/api.php?api=paypal_capture`,{
        method:'POST',
        body: JSON.stringify({orderID}),
        credentials:'include'
    });
    const captured = await cap.json();
    alert("Deposit successful: $"+amt);
    loadMe();
}
</script>
</body>
</html>
